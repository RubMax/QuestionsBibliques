<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sujets</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .subject-btn {
      width: 100%;
      text-align: left;
      font-weight: bold;
      border-left: 5px solid #0d6efd;
    }
    .tag-badge {
      margin-left: 5px;
    }
    .qa-block {
      background: #f8f9fa;
      border-left: 3px solid #0d6efd;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      white-space: pre-line;
    }
  </style>
</head>
<body class="bg-light">

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Sujets</h2>
    <button id="addBtn" class="btn btn-success">➕ Ajouter</button>
  </div>

  <!-- Recherche -->
  <div class="mb-3">
    <input type="text" id="searchInput" class="form-control" placeholder="Rechercher par sujet ou tag...">
  </div>

  <!-- Liste des sujets -->
  <div id="subjectList"></div>

  <!-- Pagination -->
  <div class="d-flex justify-content-between mt-3">
    <button id="prevPage" class="btn btn-outline-primary">Précédent</button>
    <span id="pageInfo" class="align-self-center"></span>
    <button id="nextPage" class="btn btn-outline-primary">Suivant</button>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw16vU3oy-YzhDFFAOmTzjdD4w4gdOLn3uS7C6mophbCZUkP93EYtqh96bXIrw8Hweq/exec";
const PASSWORD = "18132512";

let allData = [];
let groupedData = {};
let subjects = [];
let currentPage = 1;
const pageSize = 10;

// Charger les données
async function loadData() {
  const res = await fetch(SCRIPT_URL);
  allData = await res.json();

  // Grouper par sujet
  groupedData = {};
  allData.forEach(row => {
    if (!groupedData[row.sujet]) {
      groupedData[row.sujet] = { tags: row.tags, entries: [] };
    }
    groupedData[row.sujet].entries.push(row);
  });

  subjects = Object.keys(groupedData);
  renderPage();
}

// Pagination
function renderPage() {
  const start = (currentPage - 1) * pageSize;
  const end = start + pageSize;
  const pageSubjects = subjects.slice(start, end);
  renderSubjects(pageSubjects);
  document.getElementById("pageInfo").innerText = `Page ${currentPage} / ${Math.ceil(subjects.length / pageSize)}`;

  document.getElementById("prevPage").disabled = currentPage === 1;
  document.getElementById("nextPage").disabled = currentPage === Math.ceil(subjects.length / pageSize);
}

// Afficher les sujets sous forme de boutons (accordéon)
function renderSubjects(subjectList) {
  const container = document.getElementById("subjectList");
  container.innerHTML = "";

  if (subjectList.length === 0) {
    container.innerHTML = `<p class="text-center">Aucun résultat</p>`;
    return;
  }

  subjectList.forEach(sujet => {
    const tags = groupedData[sujet].tags
      ? groupedData[sujet].tags.split(",").map(t => `<span class="badge bg-secondary tag-badge">${t.trim()}</span>`).join("")
      : "";
    const id = sujet.replace(/\s+/g, "_");

    container.innerHTML += `
      <div class="mb-3">
        <button class="btn btn-outline-primary subject-btn" data-target="#collapse_${id}">
          ${sujet} <br> ${tags}
        </button>
        <div id="collapse_${id}" class="collapse mt-2">
          ${renderQA(groupedData[sujet].entries)}
        </div>
      </div>
    `;
  });

  // Accordéon : fermer les autres sujets
  const buttons = container.querySelectorAll(".subject-btn");
  buttons.forEach(btn => {
    btn.addEventListener("click", function(){
      const targetId = this.getAttribute("data-target");
      const allCollapses = container.querySelectorAll(".collapse");

      allCollapses.forEach(c => {
        if("#"+c.id !== targetId){
          c.classList.remove("show");
        }
      });

      const target = document.querySelector(targetId);
      target.classList.toggle("show");
    });
  });
}

// Générer questions/réponses
function renderQA(entries) {
  let html = "";
  entries.forEach(row => {
    for (let i = 1; i <= 5; i++) {
      if (row[`question0${i}`]) {
        html += `
          <div class="qa-block">
            <p><strong>${row[`question0${i}`]}</strong></p>
            <p>${row[`reponse0${i}`] || ""}</p>
          </div>
        `;
      }
    }
  });
  return html;
}

// Recherche
document.getElementById("searchInput").addEventListener("input", function() {
  const term = this.value.toLowerCase();
  subjects = Object.keys(groupedData).filter(sujet =>
    sujet.toLowerCase().includes(term) ||
    (groupedData[sujet].tags && groupedData[sujet].tags.toLowerCase().includes(term))
  );
  currentPage = 1;
  renderPage();
});

// Pagination boutons
document.getElementById("prevPage").addEventListener("click", () => {
  if(currentPage > 1){
    currentPage--;
    renderPage();
  }
});
document.getElementById("nextPage").addEventListener("click", () => {
  if(currentPage < Math.ceil(subjects.length / pageSize)){
    currentPage++;
    renderPage();
  }
});

// Mot de passe pour formulaire
document.getElementById("addBtn").addEventListener("click", function(){
  const input = prompt("Entrer le mot de passe de 8 chiffres pour accéder au formulaire :");
  if(input === PASSWORD){
    window.location.href = "form.html";
  } else if(input !== null) {
    alert("Mot de passe incorrect ❌");
  }
});

// Charger au démarrage
loadData();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>



